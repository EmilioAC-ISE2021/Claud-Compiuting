# HITO 5
En este hito se ha desplegado la aplicación, se ha monitorizado el despliegue con grafana, y se ha probado el rendimiento del despliegue.

- https://sars-app.onrender.com/

## Despliegue: render.com
Render.com es un IaaS. Lo he elegido sobre otras plataformas como heroku, ditigalocean, Fly.io, Koyeb, clever cloud y otras por los siguientes motivos:

- Su plan gratuito es el mejor. Permite tener la aplicación levantada 24/7, y el hardware cumple los requisitos mínimos para spring-boot. Rechacé la mayoría de las opciones por falta de RAM, sólo render pfrece 512MB gratuitamente. El servicio tiene la desventaja de que si no se usa la app 15 minutos seguidos, se apaga, y en el siguiente acceso hay que esperar a que despierte. Pero por la manera en la que la monitorizo, esto ya no ocurre.
- Servidores en Fráncfort. No sólo permite elegir el servidor de la BD, como otros servicios, también el de la aplicación.
- Plataforma defininda en archivo de texto plano.
- Integración perfecta y sencilla con github.

La plataforma se encuentra definida en el archivo [render.yaml](/render.yaml).
Cada vez que se hace un push, se reconstruye y se vuelve a desplegar la aplicación
![dos contenedores](/hitos/recursos/5/deploys.png)

Una limitación común a todos los PaaS que he encontrado es que no permiten acceder directamente al demonio docker. Esto significa que mi contenedor de fluent-bit ya no se puede usar. No se pierde mucho, ya que render gestiona él mismo los logs.

Aquí se ven los dos servicios desplegados en render y cómo están en la unión europea.
![dos contenedores](/hitos/recursos/5/render.png)

### Configuración del despliegue

Configurar render es muy sencillo. Solo hay que meterse en la web, crear una cuenta, vincular github, + New > Blueprint y seleccionar el repositorio.

Para que funcione tenemos que tener [render.yaml](/render.yaml) en la raíz del repositorio. Paso a Analizar su estructura.

Se divide en dos secciones:

- Services: Definimos la configuración del servidor de render (plan gratuito en Fráncfort), y que la aplicación se debe construir con docker y de qué manera. Además definimos las variables de entorno necesarias para que arranque la aplicación. Usando fromDatabase, render coge los parámetros de la BD (v.gr. el hostname) y se los pasamos a spring-boot.

- Databases: Definimos la base de datos. Por defecto es postgres así que no he tenido que configurar más que el nombre y la configuración del servidor.

## Monitorización

###Prometheus
Lo primero que he hecho ha sido añadir y configurar Prometheus en mi aplicación. Las métricas se exponen en /actuator/prometheus
###Grafana


## Rendimiento

Para finalizar, he hecho un análisis del rendimiento de la aplicación con el script [audit.py](/audit.py), que usa la librería request para hacer peticiones a la página y así medir la latencia.

![rend1](/hitos/recursos/5/rend1.png)
![rend2](/hitos/recursos/5/rend2.png)

El rendimiento no es excelente. El tiempo medio de respuesta es de 143 ms. Como se puede ver en la segunda gráfica, en ocasiones tarda más. En mis peores resultados ha llegado a tardar un segundo entero en responder. 


