<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout :: layout(content=~{::content}, titulo=${serie.nombre})}">

<th:block th:fragment="content">

    <a th:href="@{/}" class="btn btn-outline-secondary btn-sm mb-2">&larr; Volver a series</a>
    <h2 class="mb-0" th:text="${serie.nombre}">Nombre de la Serie</h2>
    <p th:text="${serie.descripcion}">Descripción de la serie</p>
    <hr>

    <div sec:authorize="hasRole('ROLE_LIDER')">
        <div class="form-add-capitulo card p-3 mb-4">
            <h4 class="mb-3">Añadir Capítulos</h4>
            <form id="formCrearCapitulos" method="post" th:action="@{/serie/{nombreSerie}/capitulo/crear(nombreSerie=${serie.nombre})}">
                <div class="mb-3">
                    <label for="nombresCapitulos" class="form-label">Nombres de los Capítulos (uno por línea)</label>
                    <textarea class="form-control" id="nombresCapitulos" name="nombresCapitulos" rows="5" placeholder="Capítulo 1&#10;Capítulo 2&#10;Capítulo 3" required></textarea>
                </div>

                <hr>

                <h5 class="mb-3">Tareas comunes</h5>
                <div id="task-template-container">
                    <!-- Fila de Tarea CC por defecto -->
                    <div class="row g-3 align-items-center mb-2" id="fila-tarea-0">
                        <div class="col-md-4">
                            <input type="text" class="form-control" id="nombre-tarea-0" value="CC" readonly onchange="actualizarInputOcultoTarea(0)">
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="estado-tarea-0" onchange="actualizarInputOcultoTarea(0)">
                                <option th:each="estado : ${todosLosEstados}" th:value="${estado}" th:text="${estado}" th:selected="${estado.toString() == 'NoAsignado'}"></option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="usuario-tarea-0" onchange="actualizarInputOcultoTarea(0)">
                                <option value="NADIE" selected>-- Sin Asignar --</option>
                                <option th:each="username : ${usuariosDelGrupo}" th:value="${username}" th:text="${username}"></option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <!-- Botón de eliminar oculto para la tarea CC por defecto -->
                        </div>
                        <input type="hidden" name="tareasEnMasa" id="input-oculto-tarea-0" value="CC###NoAsignado###NADIE">
                    </div>
                    <!-- Las filas de tareas adicionales se añadirán aquí dinámicamente -->
                </div>
                <button type="button" class="btn btn-outline-secondary btn-sm mt-2" onclick="añadirFilaTarea()">+ Añadir Tarea</button>

                <hr>
                
                <button type="submit" class="btn btn-primary mt-3">Añadir Capítulos</button>
            </form>

            <script th:inline="javascript">
                /*<![CDATA[*/
                let indiceTarea = 1; // Empezar en 1 porque la tarea 0 (CC) ya está hardcodeada
                const usuariosDisponibles = /*[[${usuariosDelGrupo}]]*/ [];
                const estadosDisponibles = /*[[${todosLosEstados}]]*/ [];

                // Función para actualizar el valor del input oculto de la tarea
                function actualizarInputOcultoTarea(indice) {
                    const nombre = document.getElementById(`nombre-tarea-${indice}`).value;
                    const usuario = document.getElementById(`usuario-tarea-${indice}`).value;
                    const estado = document.getElementById(`estado-tarea-${indice}`).value;
                    const inputOculto = document.getElementById(`input-oculto-tarea-${indice}`);
                    
                    if (nombre) { // Solo establecer el valor si el nombre está presente
                        inputOculto.value = `${nombre}###${estado}###${usuario}`;
                    } else {
                        inputOculto.value = ''; // Limpiar valor si el nombre está vacío
                    }
                }

                // Función para añadir una nueva fila de tarea a la plantilla
                function añadirFilaTarea() {
                    const contenedor = document.getElementById('task-template-container');
                    
                    const filaTarea = document.createElement('div');
                    filaTarea.classList.add('row', 'g-3', 'align-items-center', 'mb-2');
                    filaTarea.setAttribute('id', 'fila-tarea-' + indiceTarea);

                    let opcionesUsuario = '<option value="NADIE" selected>-- Sin Asignar --</option>';
                    usuariosDisponibles.forEach(username => {
                        opcionesUsuario += `<option value="${username}">${username}</option>`;
                    });

                    let opcionesEstado = '';
                    estadosDisponibles.forEach(estado => {
                        const seleccionado = estado.toString() === 'NoAsignado' ? 'selected' : '';
                        opcionesEstado += `<option value="${estado}" ${seleccionado}>${estado}</option>`;
                    });

                    filaTarea.innerHTML = `
                        <div class="col-md-4">
                            <input type="text" class="form-control" id="nombre-tarea-${indiceTarea}" placeholder="Nombre de la tarea" required onchange="actualizarInputOcultoTarea(${indiceTarea})">
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="estado-tarea-${indiceTarea}" onchange="actualizarInputOcultoTarea(${indiceTarea})">
                                ${opcionesEstado}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="usuario-tarea-${indiceTarea}" onchange="actualizarInputOcultoTarea(${indiceTarea})">
                                ${opcionesUsuario}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-danger btn-sm" onclick="eliminarFilaTarea(${indiceTarea})">Eliminar</button>
                        </div>
                        <input type="hidden" name="tareasEnMasa" id="input-oculto-tarea-${indiceTarea}">
                    `;
                    
                    contenedor.appendChild(filaTarea);
                    // Inicializar el valor del input oculto al añadir la fila
                    actualizarInputOcultoTarea(indiceTarea);
                    indiceTarea++;
                }

                // Función para eliminar una fila de tarea de la plantilla
                function eliminarFilaTarea(indice) {
                    const filaTarea = document.getElementById('fila-tarea-' + indice);
                    if (filaTarea) {
                        filaTarea.remove();
                    }
                }
                /*]]>*/
            </script>
        </div>
    </div>

    <h4 class="mb-3">Capítulos</h4>
    
    <div th:if="${serie.capitulos.isEmpty()}" class="alert alert-info">
        Esta serie aún no tiene capítulos. ¡Añade uno!
    </div>

    <div th:unless="${serie.capitulos.isEmpty()}">
            <div class="capitulo card mb-3" th:each="capitulo : ${serie.capitulos}" th:if="${capitulo != null}"
                 th:with="ccTask=${capitulo.tareas.?[nombre == 'CC'][0]}, 
                          ccCompleted=${ccTask != null and ccTask.estadoTarea == T(cc.sars.model.EstadosTareas).Completado},
                          isLeader=${usuarioActual.role.name() == 'ROLE_LIDER'},
                          isUser=${usuarioActual.role.name() == 'ROLE_USER'},
                          isQC=${usuarioActual.role.name() == 'ROLE_QC'}"
                 th:classappend="${ccCompleted ? 'border-success border-5' : ''}">        
        <div class="card-header">
            <h5 class="mb-0" th:text="${capitulo.nombre}">Nombre del Capítulo</h5>
        </div>
        
        <div class="card-body">
            <div class="tareas-container d-flex flex-wrap align-items-start">
                
            <div class="tareas-container d-flex flex-wrap align-items-start">
                
                <!-- Renderizar tareas que NO son 'CC' primero -->
                <div class="tarea-card card p-3 me-2 mb-2 border-5"
                     th:each="tarea : ${capitulo.tareas.?[nombre != 'CC']}"
                     th:classappend="${tarea.nombre == 'CC' and tarea.estadoTarea.name() == 'NoAsignado' ? 'border-warning-subtle' : 
                                     (tarea.estadoTarea.name() == 'Completado' ? 'border-success-subtle' : 
                                     (tarea.estadoTarea.name() == 'Repetir' ? 'border-danger-subtle' : 
                                     (tarea.estadoTarea.name() == 'Asignado' ? 'border-primary-subtle' : '')))}"
                     th:with="canModifyTaskStatus=${isLeader or (not ccCompleted and ( (isUser and (tarea.usuarioAsignado == 'NADIE' or tarea.usuarioAsignado == usuarioActual.username)) or (isQC and (tarea.estadoTarea.name() == 'Completado' or tarea.usuarioAsignado == 'NADIE' or tarea.usuarioAsignado == usuarioActual.username)) ) )}">
                    
                    <strong th:text="${tarea.nombre}">Nombre de Tarea</strong>
                    
                    <!-- Desplegable para asignar usuario (solo para LIDER y tareas Asignado/Completado) -->
                    <div th:if="${isLeader and (tarea.estadoTarea.name() == 'Asignado' or tarea.estadoTarea.name() == 'Completado')}">
                        <form method="post" th:action="@{/serie/{ns}/capitulo/{nc}/tarea/{nt}/asignarUsuario(ns=${serie.nombre}, nc=${capitulo.nombre}, nt=${tarea.nombre})}">
                            <label for="asignarUsuario" class="form-label-sm mb-0">Usuario:</label>
                            <select name="nuevoUsuarioAsignado" onchange="this.form.submit()" class="form-select form-select-sm">
                                <option th:each="username : ${usuariosDelGrupo}"
                                        th:value="${username}"
                                        th:text="${username}"
                                        th:selected="${username == tarea.usuarioAsignado}">
                                    Usuario
                                </option>
                            </select>
                            <noscript><button type="submit" class="btn btn-sm btn-primary mt-2">Asignar</button></noscript>
                        </form>
                    </div>
                    <p th:unless="${isLeader and (tarea.estadoTarea.name() == 'Asignado' or tarea.estadoTarea.name() == 'Completado')}"
                       class="mb-1" th:text="'Usuario: ' + ${tarea.usuarioAsignado}">Usuario: Nadie</p>

                    <!-- Lógica para mostrar el desplegable o solo el texto del estado -->
                    <div th:if="${canModifyTaskStatus}">
                        <form method="post" th:action="@{/serie/{ns}/capitulo/{nc}/tarea/{nt}/estado(ns=${serie.nombre}, nc=${capitulo.nombre}, nt=${tarea.nombre})}">
                            <select name="estado" onchange="this.form.submit()" class="form-select form-select-sm">
                                <!-- LÓGICA DE TAREAS REGULARES -->
                                <th:block th:if="${tarea.nombre != 'CC'}">
                                    <!-- Opciones para LÍDER -->
                                    <th:block th:if="${usuarioActual.role.name() == 'ROLE_LIDER'}">
                                        <option th:each="e : ${todosLosEstados}"
                                                th:value="${e}"
                                                th:text="${e}"
                                                th:selected="${e == tarea.estadoTarea}">
                                            Estado
                                        </option>
                                    </th:block>

                                    <!-- Opciones para USUARIO -->
                                    <th:block th:if="${usuarioActual.role.name() == 'ROLE_USER' and (capitulo.tareas.?[nombre == 'CC'].empty or capitulo.tareas.?[nombre == 'CC'].![estadoTarea].get(0) != T(cc.sars.model.EstadosTareas).Completado)}">
                                        <option th:each="e : ${todosLosEstados}"
                                                th:value="${e}"
                                                th:text="${e}"
                                                th:selected="${e == tarea.estadoTarea}"
                                                th:if="${
                                                    e == tarea.estadoTarea or
                                                    ((tarea.estadoTarea.name() == 'NoAsignado' or tarea.estadoTarea.name() == 'Repetir') and e.name() == 'Asignado') or
                                                    (tarea.estadoTarea.name() == 'Asignado' and (e.name() == 'Completado' or e.name() == 'NoAsignado')) or
                                                    (tarea.estadoTarea.name() == 'Completado' and e.name() == 'Repetir')
                                                }">
                                            Estado
                                        </option>
                                    </th:block>

                                    <!-- Opciones para USUARIO_CC -->
                                    <th:block th:if="${usuarioActual.role.name() == 'ROLE_QC'}">
                                        <option th:each="e : ${todosLosEstados}"
                                                th:value="${e}"
                                                th:text="${e}"
                                                th:selected="${e == tarea.estadoTarea}"
                                                th:if="${
                                                    e == tarea.estadoTarea or
                                                    ((tarea.estadoTarea.name() == 'NoAsignado' or tarea.estadoTarea.name() == 'Repetir') and e.name() == 'Asignado') or
                                                    (tarea.estadoTarea.name() == 'Asignado' and (e.name() == 'Completado' or e.name() == 'NoAsignado')) or
                                                    (tarea.estadoTarea.name() == 'Completado' and e.name() == 'Repetir')
                                                }">
                                            Estado
                                        </option>
                                    </th:block>
                                </th:block>
                            </select>
                            <noscript><button type="submit" class="btn btn-sm btn-primary mt-2">Actualizar</button></noscript>
                        </form>
                    </div>
                    <div th:unless="${canModifyTaskStatus}">
                        <p class="mb-0" th:text="${tarea.estadoTarea}">Estado de Tarea</p>
                    </div>
                </div>

                <!-- Renderizar la tarea 'CC' al final, si existe -->
                                    <div th:with="ccTask=${capitulo.tareas.?[nombre == 'CC'][0]}" sec:authorize="hasAnyRole('ROLE_LIDER', 'ROLE_QC')">                    <div th:if="${ccTask != null}"
                         class="tarea-card card p-3 me-2 mb-2 border-5"
                         th:classappend="${ccTask.nombre == 'CC' and ccTask.estadoTarea.name() == 'NoAsignado' ? 'border-warning-subtle' : 
                                         (ccTask.estadoTarea.name() == 'Completado' ? 'border-success-subtle' : 
                                         (ccTask.estadoTarea.name() == 'Repetir' ? 'border-danger-subtle' : 
                                         (ccTask.estadoTarea.name() == 'Asignado' ? 'border-primary-subtle' : '')))}"
                         th:with="canModifyCCTaskStatus=${isLeader or (not ccCompleted and isQC and (ccTask.estadoTarea.name() == 'Completado' or ccTask.usuarioAsignado == 'NADIE' or ccTask.usuarioAsignado == usuarioActual.username))}">
                        
                        <strong th:text="${ccTask.nombre}">Nombre de Tarea</strong>
                        
                        <!-- Desplegable para asignar usuario (solo para LIDER y tareas Asignado/Completado) -->
                        <div th:if="${isLeader and (ccTask.estadoTarea.name() == 'Asignado' or ccTask.estadoTarea.name() == 'Completado')}">
                            <form method="post" th:action="@{/serie/{ns}/capitulo/{nc}/tarea/{nt}/asignarUsuario(ns=${serie.nombre}, nc=${capitulo.nombre}, nt=${ccTask.nombre})}">
                                <label for="asignarUsuarioCC" class="form-label-sm mb-0">Usuario:</label>
                                <select name="nuevoUsuarioAsignado" onchange="this.form.submit()" class="form-select form-select-sm">
                                    <option th:each="username : ${usuariosDelGrupo}"
                                            th:value="${username}"
                                            th:text="${username}"
                                            th:selected="${username == ccTask.usuarioAsignado}">
                                        Usuario
                                    </option>
                                </select>
                                <noscript><button type="submit" class="btn btn-sm btn-primary mt-2">Asignar</button></noscript>
                            </form>
                        </div>
                        <p th:unless="${isLeader and (ccTask.estadoTarea.name() == 'Asignado' or ccTask.estadoTarea.name() == 'Completado')}"
                           class="mb-1" th:text="'Usuario: ' + ${ccTask.usuarioAsignado}">Usuario: Nadie</p>

                        <!-- Lógica para mostrar el desplegable o solo el texto del estado para CC Task -->
                        <div th:if="${canModifyCCTaskStatus}">
                            <form method="post" th:action="@{/serie/{ns}/capitulo/{nc}/tarea/{nt}/estado(ns=${serie.nombre}, nc=${capitulo.nombre}, nt=${ccTask.nombre})}">
                                <select name="estado" onchange="this.form.submit()" class="form-select form-select-sm">
                                    <!-- LÓGICA DE TAREA CC -->
                                    <th:block th:if="${ccTask.nombre == 'CC'}">
                                        <!-- Opciones para LÍDER -->
                                        <th:block th:if="${usuarioActual.role.name() == 'ROLE_LIDER'}">
                                            <option th:each="e : ${todosLosEstados}"
                                                    th:value="${e}"
                                                    th:text="${e}"
                                                    th:selected="${e == ccTask.estadoTarea}">
                                                Estado
                                            </option>
                                        </th:block>
                                        <!-- Opciones para USUARIO_CC -->
                                        <th:block th:if="${usuarioActual.role.name() == 'ROLE_QC'}">
                                            <option th:each="e : ${todosLosEstados}"
                                                    th:value="${e}"
                                                    th:text="${e}"
                                                    th:selected="${e == ccTask.estadoTarea}"
                                                    th:if="${
                                                        e == ccTask.estadoTarea or
                                                        ((ccTask.estadoTarea.name() == 'NoAsignado' or ccTask.estadoTarea.name() == 'Repetir') and e.name() == 'Asignado') or
                                                        (ccTask.estadoTarea.name() == 'Asignado' and e.name() == 'Completado') or
                                                        (ccTask.estadoTarea.name() == 'Completado' and e.name() == 'Repetir')
                                                    }">
                                                Estado
                                            </option>
                                        </th:block>
                                    </th:block>
                                </select>
                                <noscript><button type="submit" class="btn btn-sm btn-primary mt-2">Actualizar</button></noscript>
                            </form>
                        </div>
                        <div th:unless="${canModifyCCTaskStatus}">
                            <p class="mb-0" th:text="${ccTask.estadoTarea}">Estado de Tarea</p>
                        </div>
                    </div>
                </div>

                <div sec:authorize="hasRole('ROLE_LIDER')">
                    <div class="form-add-tarea card p-3 me-2 mb-2" style="border-style: dashed;">
                        <form method="post" th:action="@{/serie/{ns}/capitulo/{nc}/tarea/crear(ns=${serie.nombre}, nc=${capitulo.nombre})}">
                            <input type="text" class="form-control mb-2" name="nombreTarea" placeholder="Nueva Tarea" required>
                            <button type="submit" class="btn btn-outline-primary btn-sm">Añadir Tarea</button>
                        </form>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    document.addEventListener('DOMContentLoaded', function() {
        // Guardar la posición del scroll antes de recargar
        const selects = document.querySelectorAll('select[onchange="this.form.submit()"]');
        selects.forEach(select => {
            select.addEventListener('change', function() {
                sessionStorage.setItem('scrollPosition', window.scrollY);
            });
        });

        // Restaurar la posición del scroll después de la recarga
        const scrollPosition = sessionStorage.getItem('scrollPosition');
        if (scrollPosition) {
            window.scrollTo(0, parseInt(scrollPosition, 10));
            sessionStorage.removeItem('scrollPosition');
        }
    });
    /*]]>*/
</script>

</th:block>
</html>
