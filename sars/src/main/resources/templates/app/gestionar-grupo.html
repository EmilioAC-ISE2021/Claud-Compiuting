<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout :: layout(content=~{::content}, titulo='Gestionar Grupo')}">

<th:block th:fragment="content">

    <a th:href="@{/}" class="btn btn-outline-secondary btn-sm mb-3">&larr; Volver al Dashboard</a>
    
    <h2 class="mb-4">
        Gestionar Grupo: <span class="fw-bold" th:text="${grupo.nombre}">Nombre del Grupo</span>
    </h2>

    <div th:if="${success_message}" class="alert alert-success" role="alert">
        [[${success_message}]]
    </div>
    <div th:if="${error_message}" class="alert alert-danger" role="alert">
        [[${error_message}]]
    </div>

    <div class="row">
        <div class="col-md-5">
            <h4>Añadir Usuario al Grupo</h4>
            <form th:action="@{/grupo/gestionar/agregar}" method="post" class="card p-3">
                <div class="mb-3">
                    <label for="nombreUsuario" class="form-label">Selecciona un usuario:</label>
                    <select class="form-select" id="nombreUsuario" name="nombreUsuario" required>
                        <option value="" disabled selected>-- Usuarios disponibles --</option>
                        
                        <option th:each="usuario : ${usuariosDisponibles}"
                                th:value="${usuario.username}"
                                th:text="${usuario.username}">
                            username.del.usuario
                        </option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Añadir al Grupo</button>
            </form>
        </div>

        <div class="col-md-7">
            <h4>Miembros Actuales del Grupo</h4>
            <ul class="list-group">
                <li th:each="usuario : ${usuariosEnGrupo}" class="list-group-item d-flex justify-content-between align-items-center">
                    <span th:text="${usuario.username}">username.miembro</span>
                    
                    <form th:action="@{/grupo/gestionar/cambiar-rol}" method="post" class="d-inline-flex align-items-center ms-auto">
                        <input type="hidden" name="username" th:value="${usuario.username}">
                        <select name="newRole" class="form-select form-select-sm me-2" onchange="this.form.submit()">
                            <option th:each="role : ${rolesDisponibles}"
                                    th:value="${role}"
                                    th:text="${role.name() == 'ROLE_LIDER' ? 'Líder' : (role.name() == 'ROLE_USER' ? 'Usuario' : 'UsuarioCC')}"
                                    th:selected="${role == usuario.role}">
                                Rol
                            </option>
                        </select>
                        <noscript><button type="submit" class="btn btn-sm btn-primary">Cambiar Rol</button></noscript>
                    </form>
                    <form th:action="@{/grupo/gestionar/eliminarUsuario}" method="post" class="d-inline-flex ms-2">
                        <input type="hidden" name="nombreGrupo" th:value="${grupo.nombre}">
                        <input type="hidden" name="username" th:value="${usuario.username}">
                        <button type="submit" class="btn btn-danger btn-sm"
                                th:disabled="${(usuario.username == user.username) or (usuario.role.name() == 'ROLE_LIDER' and liderCount == 1)}"
                                th:onclick="return confirm('¿Estás seguro de que quieres eliminar a este usuario del grupo?');">
                            Eliminar
                        </button>
                    </form>
                </li>
            </ul>
        </div>
    </div>

</th:block>
</html>